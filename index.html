<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Record App - Revenue & Expense</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s;
        }
        .container-card:hover {
            box-shadow: 0 15px 35px -8px rgba(0, 0, 0, 0.15), 0 7px 15px -7px rgba(0, 0, 0, 0.08);
        }
        .input-style {
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        /* Style for the real-time feedback box */
        #feedbackMessage {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .show-feedback {
            opacity: 1 !important;
        }
        /* Print-specific styles to ensure only the receipt is visible when printing */
        @media print {
            body > *:not(#printReceipt) {
                display: none; /* Hide everything except the receipt container */
            }
            #printReceipt {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                /* Ensure receipt content is clean and small for thermal/office printer */
                font-family: monospace; 
                font-size: 10pt;
            }
            /* Reset body padding for print */
            body {
                padding: 0 !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-800">Business Record App</h1>
            <p class="text-lg text-gray-600 mt-2">Record Transactions (Revenue & Expense)</p>
        </header>

        <!-- Loading & Status State -->
        <div id="loadingIndicator" class="text-center text-xl text-blue-500 font-semibold mb-6">
            Loading data... (Using Local Storage)
        </div>

        <!-- Feedback Message -->
        <div id="feedbackMessage" class="fixed top-5 right-5 z-50 p-4 rounded-lg text-white font-medium shadow-xl"></div>

        <!-- Main Content -->
        <main id="mainContent" class="grid grid-cols-1 lg:col-cols-3 gap-8 hidden">
            <!-- Left Column: Add New Transaction Form -->
            <div class="lg:col-span-1 p-6 bg-white rounded-xl container-card">
                <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Add New Record</h2>

                <form id="recordForm">
                    
                    <!-- Transaction Type Selector -->
                    <div class="mb-6 p-3 bg-blue-50 rounded-lg">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Transaction Type:</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="transactionType" value="Revenue" class="form-radio text-blue-600 h-4 w-4" checked>
                                <span class="ml-2 text-blue-700 font-medium">Revenue (Sale)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="transactionType" value="Expense" class="form-radio text-red-600 h-4 w-4">
                                <span class="ml-2 text-red-700 font-medium">Expense (Cost)</span>
                            </label>
                        </div>
                    </div>

                    <!-- REVENUE FIELDS (Multi-Item) -->
                    <div id="revenueFields" class="space-y-4">
                        <!-- Dynamic Item Container -->
                        <div id="itemsContainer" class="space-y-4 mb-4 border p-3 rounded-lg bg-white">
                            <p class="text-sm font-medium text-gray-700 mb-2">Sale Items (Add at least one)</p>
                            <!-- Item rows will be dynamically injected here -->
                        </div>

                        <!-- Add Item Button -->
                        <button type="button" id="addItemButton" class="w-full text-blue-600 border border-blue-600 p-2 rounded-lg font-semibold hover:bg-blue-50 transition duration-150 mb-6 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Service/Item
                        </button>
                    </div>

                    <!-- EXPENSE FIELDS -->
                    <div id="expenseFields" class="space-y-4 hidden">
                         <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Expense Category</label>
                            <select id="expenseCategory" required class="input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                                <option value="" disabled selected>Select Category</option>
                                <option value="Rent">Rent</option>
                                <option value="Utilities">Utilities (Electricity/Internet)</option>
                                <option value="Supplies">Supplies (Paper/Ink)</option>
                                <option value="Salary">Salary/Wages</option>
                                <option value="Maintenance">Maintenance/Repair</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <input type="text" id="expenseDescription" placeholder="Brief reason or vendor name" required class="input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" min="1" value="" step="any" id="expenseAmount" placeholder="e.g., 5000" required class="input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                        </div>
                    </div>


                    <!-- Total Cost Display (for Revenue) or Amount (for Expense) -->
                    <div class="mb-6 p-4 rounded-lg border" id="totalDisplayCard">
                        <p class="text-sm font-medium text-blue-800" id="totalLabel">Grand Total Cost:</p>
                        <p id="totalCostDisplay" class="text-2xl font-bold text-blue-600 mt-1">0.00</p>
                    </div>

                    <button type="submit" id="saveButton" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50" disabled>
                        <span id="buttonText">Save Transaction & Print Receipt</span>
                        <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Right Column: Record List and Summary -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Daily Performance Card (Net Profit) -->
                <div class="p-6 bg-blue-50 rounded-xl container-card border border-blue-200">
                    <h2 class="text-2xl font-bold text-blue-800 mb-4">Today's Net Profit (Revenue - Expense)</h2>
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-lg text-blue-700">Total Revenue:</p>
                        <p id="dailyRevenue" class="text-3xl font-extrabold text-blue-600">0.00</p>
                    </div>
                    <div class="flex justify-between items-center border-b border-blue-200 pb-2 mb-2">
                        <p class="text-lg text-red-700">Total Expense:</p>
                        <p id="dailyExpense" class="text-3xl font-extrabold text-red-600">0.00</p>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <p class="text-xl font-bold text-gray-800">NET PROFIT:</p>
                        <p id="dailyNetProfit" class="text-4xl font-extrabold text-blue-800">0.00</p>
                    </div>
                </div>

                <!-- Record List -->
                <div class="p-6 bg-white rounded-xl container-card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Recent Records</h2>

                    <!-- Table for records -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Type</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Item/Description</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Amount</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Date/Time</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Action</th>
                                </tr>
                            </thead>
                            <tbody id="recordsList" class="bg-white divide-y divide-gray-200">
                                <!-- Records will be injected here -->
                            </tbody>
                        </table>
                        <p id="noRecordsMessage" class="text-center text-gray-500 p-4 hidden">No transactions have been added yet.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Print Receipt Structure (Hidden by default, shown only during print) -->
    <div id="printReceipt" class="hidden max-w-xs mx-auto text-black p-4">
        <!-- Content injected by JavaScript -->
    </div>

    <!-- Local Storage Logic -->
    <script>
        // UI elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const recordForm = document.getElementById('recordForm');
        const recordsList = document.getElementById('recordsList');
        const dailyRevenueEl = document.getElementById('dailyRevenue');
        const dailyExpenseEl = document.getElementById('dailyExpense');
        const dailyNetProfitEl = document.getElementById('dailyNetProfit');
        const totalCostDisplay = document.getElementById('totalCostDisplay');
        const totalLabel = document.getElementById('totalLabel');
        const totalDisplayCard = document.getElementById('totalDisplayCard');
        const saveButton = document.getElementById('saveButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const noRecordsMessage = document.getElementById('noRecordsMessage');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const printReceiptEl = document.getElementById('printReceipt');
        const itemsContainer = document.getElementById('itemsContainer');
        const addItemButton = document.getElementById('addItemButton');
        const transactionTypeInputs = document.querySelectorAll('input[name="transactionType"]');
        
        // Expense Fields
        const revenueFields = document.getElementById('revenueFields');
        const expenseFields = document.getElementById('expenseFields');
        const expenseCategory = document.getElementById('expenseCategory');
        const expenseDescription = document.getElementById('expenseDescription');
        const expenseAmount = document.getElementById('expenseAmount');
        
        const LOCAL_STORAGE_KEY = 'shop_multi_item_records_data_v2'; // Updated key for new data structure
        let itemIdCounter = 0; // Counter for unique item IDs within the current form

        const SERVICE_OPTIONS = [
            "Photocopy (B/W)",
            "B/W Printing",
            "Color Printing",
            "Scanning",
            "Binding",
            "Lamination",
            "Stationary Sale",
            "Other Sale"
        ];
        
        const BUSINESS_INFO = {
            shopName: "Zaman Printing Services",
            address: "Basement No. 6, Al-Anayat Shopping Mall, G-11 Markaz, Islamabad",
            phone: "0348-0649535"
        };


        // --- Utility Functions ---

        /**
         * Shows a temporary feedback message to the user.
         */
        function showFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = 'fixed top-5 right-5 z-50 p-4 rounded-lg text-white font-medium shadow-xl show-feedback';

            if (type === 'success') {
                feedbackMessage.classList.add('bg-green-500');
            } else if (type === 'error') {
                feedbackMessage.classList.add('bg-red-500');
            } else {
                feedbackMessage.classList.add('bg-gray-500');
            }

            // Hide after 3 seconds
            setTimeout(() => {
                feedbackMessage.classList.remove('show-feedback');
                feedbackMessage.classList.add('opacity-0');
            }, 3000);
        }

        /**
         * Formats a number to a currency string.
         */
        function formatCurrency(num) {
            // Use Number() to ensure it's treated as a number before fixed
            return Number(num).toFixed(2);
        }

        /**
         * Toggles form fields based on the selected transaction type.
         */
        function toggleFormFields(type) {
            const isRevenue = type === 'Revenue';

            // Toggle visibility
            revenueFields.classList.toggle('hidden', !isRevenue);
            expenseFields.classList.toggle('hidden', isRevenue);

            // Update display card aesthetics/labels
            if (isRevenue) {
                totalDisplayCard.classList.remove('bg-red-50', 'border-red-200');
                totalDisplayCard.classList.add('bg-blue-50', 'border-blue-200');
                totalLabel.textContent = 'Grand Total Cost:';
                totalCostDisplay.classList.remove('text-red-600');
                totalCostDisplay.classList.add('text-blue-600');
                buttonText.textContent = 'Save Revenue & Print Receipt';
                // Trigger revenue calculation
                calculateGrandTotal(); 
            } else {
                totalDisplayCard.classList.remove('bg-blue-50', 'border-blue-200');
                totalDisplayCard.classList.add('bg-red-50', 'border-red-200');
                totalLabel.textContent = 'Expense Amount:';
                totalCostDisplay.classList.remove('text-blue-600');
                totalCostDisplay.classList.add('text-red-600');
                buttonText.textContent = 'Save Expense';
                // Trigger expense calculation/validation
                handleExpenseFormUpdate();
            }
        }
        
        transactionTypeInputs.forEach(input => {
            input.addEventListener('change', (e) => toggleFormFields(e.target.value));
        });
        
        // --- Revenue (Sale) Logic ---

        /**
         * Calculates the total cost of a single item row.
         */
        function calculateItemTotal(itemEl) {
            const quantityInput = itemEl.querySelector('.item-quantity');
            const priceInput = itemEl.querySelector('.item-price');
            const totalDisplay = itemEl.querySelector('.item-total-display');

            const qty = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;

            totalDisplay.textContent = formatCurrency(total);
            return total;
        }

        /**
         * Calculates the Grand Total from all item rows and updates the display/button state.
         */
        function calculateGrandTotal() {
            const itemRows = itemsContainer.querySelectorAll('.item-row');
            let grandTotal = 0;
            let isValid = itemRows.length > 0;

            itemRows.forEach(row => {
                const itemTotal = calculateItemTotal(row);
                grandTotal += itemTotal;
                
                // Check validity for form submission
                const quantityInput = row.querySelector('.item-quantity');
                const priceInput = row.querySelector('.item-price');
                const typeSelect = row.querySelector('.item-type');

                if (!typeSelect.value || !quantityInput.value || !priceInput.value || itemTotal <= 0) {
                    isValid = false;
                }
            });

            totalCostDisplay.textContent = formatCurrency(grandTotal);
            
            // The button is enabled only if Revenue is selected, there is at least one valid item row, and the total > 0
            saveButton.disabled = !isValid || grandTotal <= 0;
        }

        /**
         * Adds a new item input row to the form.
         */
        function addItemRow() {
            itemIdCounter++;
            const rowId = `item-row-${itemIdCounter}`;

            const itemDiv = document.createElement('div');
            itemDiv.id = rowId;
            itemDiv.className = 'item-row bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 relative';
            itemDiv.innerHTML = `
                <button type="button" data-row-id="${rowId}" class="remove-item-btn absolute top-2 right-2 text-red-500 hover:text-red-700 p-1 rounded-full bg-white shadow-md" title="Remove Item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <!-- Service Type -->
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Service</label>
                        <select required class="item-type input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                            <option value="" disabled selected>Select Service</option>
                            ${SERVICE_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>

                    <!-- Details/Description -->
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Details (e.g., A4, Spiral, Pen Name)</label>
                        <input type="text" placeholder="Details" class="item-details input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                    </div>

                    <!-- Quantity -->
                    <div class="md:col-span-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Qty</label>
                        <input type="number" min="1" value="1" required class="item-quantity input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                    </div>

                    <!-- Price Per Unit -->
                    <div class="md:col-span-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Rate</label>
                        <input type="number" min="0" value="0" step="any" required class="item-price input-style w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                    </div>

                    <!-- Item Total -->
                    <div class="md:col-span-2 text-right self-end">
                        <p class="text-xs font-medium text-gray-500 mb-1">Item Total:</p>
                        <p class="item-total-display text-lg font-bold text-blue-500">0.00</p>
                    </div>
                </div>
            `;
            
            itemsContainer.appendChild(itemDiv);

            // Add event listeners for calculation and removal
            itemDiv.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', calculateGrandTotal);
            });
            itemDiv.querySelector('.remove-item-btn').addEventListener('click', removeItemRow);

            calculateGrandTotal(); // Recalculate and validate form state
        }
        
        /**
         * Removes an item input row from the form.
         */
        function removeItemRow(e) {
            const rowId = e.currentTarget.getAttribute('data-row-id');
            const rowToRemove = document.getElementById(rowId);
            if (rowToRemove) {
                rowToRemove.remove();
                calculateGrandTotal(); // Recalculate and validate form state
            }
        }
        
        addItemButton.addEventListener('click', addItemRow);


        // --- Expense Logic ---

        function handleExpenseFormUpdate() {
            const amount = parseFloat(expenseAmount.value) || 0;
            const category = expenseCategory.value;
            const description = expenseDescription.value.trim();
            
            totalCostDisplay.textContent = formatCurrency(amount);

            // Expense is valid if amount > 0 and a category and description are provided
            const isValid = amount > 0 && category && description;
            saveButton.disabled = !isValid;
        }

        // Add listeners for expense fields
        expenseCategory.addEventListener('input', handleExpenseFormUpdate);
        expenseDescription.addEventListener('input', handleExpenseFormUpdate);
        expenseAmount.addEventListener('input', handleExpenseFormUpdate);
        

        // --- Local Storage Operations ---

        /**
         * Retrieves all records from Local Storage.
         */
        function getRecords() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : [];
            } catch (error) {
                console.error("Error loading records from Local Storage:", error);
                return [];
            }
        }

        /**
         * Saves the entire records array to Local Storage.
         */
        function saveRecords(records) {
            try {
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records));
            } catch (error) {
                console.error("Error saving records to Local Storage:", error);
                showFeedback('Error: Could not save data locally. Storage full?', 'error');
            }
        }

        /**
         * Adds a new record (transaction) to Local Storage.
         */
        function addRecord(newRecord) {
            const records = getRecords();
            // Assign a simple unique ID
            const id = Date.now().toString();
            const recordWithId = { id, ...newRecord };

            records.push(recordWithId);
            saveRecords(records);
            loadAndRenderRecords(); // Re-render after saving
            return recordWithId;
        }

        /**
         * Deletes a record (transaction) from Local Storage by ID.
         */
        function deleteRecord(id) {
            let records = getRecords();
            const initialLength = records.length;
            records = records.filter(record => record.id !== id);

            if (records.length < initialLength) {
                saveRecords(records);
                loadAndRenderRecords(); // Re-render after deleting
                showFeedback('Record successfully deleted.', 'success');
            } else {
                showFeedback('Error: Record not found.', 'error');
            }
        }

        // --- Printing Functionality (Only for Revenue) ---

        /**
         * Generates and triggers the print dialogue for the customer receipt.
         */
        function generateAndPrintReceipt(record) {
            if (record.type !== 'Revenue') {
                showFeedback('Only Revenue records can generate a customer receipt.', 'error');
                return;
            }

            const date = new Date(record.timestamp);
            const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Generate table rows for all items
            const itemRowsHTML = record.items.map(item => `
                <tr>
                    <td style="text-align: left; padding-top: 5px;">
                        ${item.type}
                        ${item.details ? `<span style="display: block; font-size: 7pt; color: #555;">(${item.details})</span>` : ''}
                    </td>
                    <td style="text-align: right; padding-top: 5px;">${item.quantity}</td>
                    <td style="text-align: right; padding-top: 5px;">${formatCurrency(item.price_per_unit)}</td>
                    <td style="text-align: right; padding-top: 5px; font-weight: bold;">${formatCurrency(item.total_cost)}</td>
                </tr>
            `).join('');


            const receiptHTML = `
                <div style="text-align: center; border-bottom: 1px dashed black; padding-bottom: 5px; margin-bottom: 5px;">
                    <h3 style="font-size: 14pt; margin: 0; font-weight: bold;">${BUSINESS_INFO.shopName}</h3>
                    <p style="font-size: 8pt; margin: 2px 0;">${BUSINESS_INFO.address}</p>
                    <p style="font-size: 9pt; margin: 2px 0; font-weight: bold;">${BUSINESS_INFO.phone}</p>
                    <p style="font-size: 8pt; margin: 2px 0;">Thank you for your business!</p>
                </div>
                
                <p style="font-size: 9pt; margin: 2px 0;">Date: ${formattedDate}</p>
                <p style="font-size: 9pt; margin: 2px 0; border-bottom: 1px dashed black; padding-bottom: 5px;">Time: ${formattedTime}</p>

                <table style="width: 100%; margin-top: 5px; font-size: 9pt;">
                    <thead>
                        <tr style="border-bottom: 1px dashed black;">
                            <th style="text-align: left;">Item/Service</th>
                            <th style="text-align: right;">Qty</th>
                            <th style="text-align: right;">Rate</th>
                            <th style="text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemRowsHTML}
                    </tbody>
                </table>
                
                <div style="text-align: right; margin-top: 10px; border-top: 1px dashed black; padding-top: 5px;">
                    <p style="font-size: 11pt; font-weight: bold;">Grand Total: ${formatCurrency(record.total_cost)}</p>
                </div>

                <div style="text-align: center; margin-top: 10px; font-size: 8pt; border-top: 1px dashed black; padding-top: 5px;">
                    <p>Transaction ID: ${record.id}</p>
                    <p>Goods once sold cannot be returned.</p>
                </div>
            `;

            printReceiptEl.innerHTML = receiptHTML;
            
            // Trigger the native print dialog
            window.print();
        }


        // --- Rendering and Initialization ---

        /**
         * Loads records, calculates daily performance, and initiates rendering.
         */
        function loadAndRenderRecords() {
            // Ensure at least one item row is present when the app loads
            if (itemsContainer.children.length === 0) {
                addItemRow();
            }

            const records = getRecords();
            let dailyTotalRevenue = 0;
            let dailyTotalExpense = 0;
            
            // Get today's date at midnight for comparison
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            records.forEach((record) => {
                const recordDate = new Date(record.timestamp);

                // Calculate daily totals: check if record date is >= today's midnight
                if (recordDate >= todayStart) {
                    const amount = parseFloat(record.total_cost || 0);
                    if (record.type === 'Revenue') {
                        dailyTotalRevenue += amount;
                    } else if (record.type === 'Expense') {
                        dailyTotalExpense += amount;
                    }
                }
            });
            
            const dailyNetProfit = dailyTotalRevenue - dailyTotalExpense;

            renderRecords(records);
            dailyRevenueEl.textContent = formatCurrency(dailyTotalRevenue);
            dailyExpenseEl.textContent = formatCurrency(dailyTotalExpense);
            dailyNetProfitEl.textContent = formatCurrency(dailyNetProfit);
            
            // Apply color to Net Profit display
            if (dailyNetProfit < 0) {
                 dailyNetProfitEl.classList.remove('text-blue-800');
                 dailyNetProfitEl.classList.add('text-red-800');
            } else {
                 dailyNetProfitEl.classList.add('text-blue-800');
                 dailyNetProfitEl.classList.remove('text-red-800');
            }


            // Once data is loaded (which is instant with localStorage), show content
            loadingIndicator.classList.add('hidden');
            mainContent.classList.remove('hidden');
            
            // Initialize form to correct state
            toggleFormFields(document.querySelector('input[name="transactionType"]:checked').value);
        }

        /**
         * Renders the records into the table.
         */
        function renderRecords(records) {
            recordsList.innerHTML = '';
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                return;
            }
            noRecordsMessage.classList.add('hidden');

            records.forEach(record => {
                const date = new Date(record.timestamp);
                const formattedDate = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });

                let descriptionContent = '';
                let amountClass = '';
                let typeColorClass = '';
                let totalAmount = formatCurrency(record.total_cost);
                let actionButtonHTML = '';


                if (record.type === 'Revenue') {
                    // For Revenue, summarize all items
                    descriptionContent = record.items.map(item => `${item.type} (x${item.quantity})`).join(', ');
                    amountClass = 'font-bold text-blue-600';
                    typeColorClass = 'bg-blue-100 text-blue-800';
                    actionButtonHTML = `
                        <button onclick="generateAndPrintReceipt(${JSON.stringify(record).replace(/"/g, '\'')})" class="text-blue-600 hover:text-blue-800 transition-colors ml-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m4 0v3a1 1 0 001 1h2a1 1 0 001-1v-3m2 0H9" />
                            </svg>
                            Print
                        </button>
                    `;
                } else if (record.type === 'Expense') {
                    // For Expense, show Category and Description
                    descriptionContent = `<span class="font-semibold">${record.category}:</span> ${record.description}`;
                    amountClass = 'font-bold text-red-600';
                    typeColorClass = 'bg-red-100 text-red-800';
                    totalAmount = '- ' + totalAmount; // Show expense as negative
                    actionButtonHTML = '<span class="text-gray-400">N/A</span>';
                }


                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-3 text-sm whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeColorClass}">
                            ${record.type}
                        </span>
                    </td>
                    <td class="px-3 py-3 text-sm font-medium text-gray-900">
                        ${descriptionContent}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm ${amountClass}">${totalAmount}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-400">${formattedDate}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${record.id}" class="delete-btn text-red-600 hover:text-red-900 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                            Delete
                        </button>
                        ${actionButtonHTML}
                    </td>
                `;
                recordsList.appendChild(row);
            });

            // Re-attach delete listeners
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
        }

        /**
         * Handles form submission to add a new record.
         */
        recordForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const transactionType = document.querySelector('input[name="transactionType"]:checked').value;
            let newRecord = null;
            let isValid = true;

            // --- REVENUE LOGIC ---
            if (transactionType === 'Revenue') {
                const grandTotal = parseFloat(totalCostDisplay.textContent);
                
                if (grandTotal <= 0) {
                    showFeedback('Grand Total must be greater than 0.', 'error');
                    isValid = false;
                } else {
                    const itemRows = itemsContainer.querySelectorAll('.item-row');
                    const items = [];
                    
                    itemRows.forEach(row => {
                        const itemTotal = parseFloat(row.querySelector('.item-total-display').textContent);
                        const item = {
                            type: row.querySelector('.item-type').value,
                            details: row.querySelector('.item-details').value.trim(),
                            quantity: parseFloat(row.querySelector('.item-quantity').value),
                            price_per_unit: parseFloat(row.querySelector('.item-price').value),
                            total_cost: itemTotal, // Changed key to total_cost for consistency in receipt logic
                        };
                        
                        // Final validation check before pushing
                        if (!item.type || item.quantity <= 0 || item.price_per_unit < 0 || item.total_cost <= 0) {
                            isValid = false;
                        }
                        
                        if(isValid) {
                            items.push(item);
                        }
                    });

                    if (!isValid || items.length === 0) {
                        showFeedback('Please ensure all revenue items are valid and have a positive total cost.', 'error');
                    } else {
                        newRecord = {
                            type: 'Revenue',
                            items: items,
                            total_cost: grandTotal,
                            timestamp: new Date().toISOString()
                        };
                    }
                }
            } 
            // --- EXPENSE LOGIC ---
            else if (transactionType === 'Expense') {
                const amount = parseFloat(expenseAmount.value);
                const category = expenseCategory.value;
                const description = expenseDescription.value.trim();

                if (amount <= 0 || !category || !description) {
                    showFeedback('Please provide a valid amount, category, and description for the expense.', 'error');
                    isValid = false;
                } else {
                    newRecord = {
                        type: 'Expense',
                        category: category,
                        description: description,
                        total_cost: amount,
                        timestamp: new Date().toISOString()
                    };
                }
            }


            if (!isValid || !newRecord) {
                // If invalid, the button will remain enabled (because of how submit works) but we stop the process.
                return;
            }

            // Disable button and show spinner briefly
            saveButton.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const savedRecord = addRecord(newRecord);
                showFeedback(`${transactionType} successfully saved!`, 'success');
                
                if (savedRecord.type === 'Revenue') {
                    // Automatically generate and print the receipt for Revenue
                    generateAndPrintReceipt(savedRecord);
                    
                    // Reset revenue form inputs for a new transaction
                    itemsContainer.innerHTML = '';
                    addItemRow(); // Add one blank row back
                } else {
                    // Reset expense form inputs
                    expenseCategory.value = '';
                    expenseDescription.value = '';
                    expenseAmount.value = '';
                }
                
                // Reset total display and re-enable button via dynamic update
                toggleFormFields(transactionType);

            } catch (error) {
                console.error("Error adding document: ", error);
                showFeedback('Error saving record: ' + error.message, 'error');
            } finally {
                // Button text and spinner are managed by toggleFormFields after the save, 
                // but we hide the spinner here just in case.
                spinner.classList.add('hidden');
            }
        });

        /**
         * Handles record deletion.
         */
        function handleDelete(e) {
            const recordId = e.currentTarget.getAttribute('data-id');
            if (!recordId) return;

            // Simple confirmation logic (using window.confirm since alert/confirm are restricted)
            if (window.confirm('Are you sure you want to delete this record?')) {
                try {
                    deleteRecord(recordId);
                } catch (error) {
                    console.error("Error deleting record:", error);
                    showFeedback('Failed to delete record.', 'error');
                }
            }
        }

        // Initialize the application by loading records and adding the first item row
        window.onload = loadAndRenderRecords;
    </script>
</body>
</html>
